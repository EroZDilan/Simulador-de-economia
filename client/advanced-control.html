<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Agents Control Panel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .control-panel {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-card {
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .btn-success {
            background: linear-gradient(45deg, #00b894, #00a085);
        }

        .btn-warning {
            background: linear-gradient(45deg, #fdcb6e, #e17055);
        }

        .btn-info {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
        }

        .bot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .bot-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .bot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .bot-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #74b9ff;
        }

        .bot-strategy {
            font-size: 0.9em;
            color: #ddd;
            background: rgba(116, 185, 255, 0.2);
            padding: 4px 8px;
            border-radius: 12px;
        }

        .bot-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #00b894;
        }

        .stat-label {
            font-size: 0.8em;
            color: #ccc;
        }

        .thinking-process {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .thinking-step {
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            border-left: 3px solid #74b9ff;
        }

        .step-title {
            font-weight: bold;
            color: #74b9ff;
            margin-bottom: 3px;
        }

        .step-explanation {
            font-size: 0.9em;
            color: #ddd;
        }

        .decision-history {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .decision-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            font-size: 0.9em;
        }

        .decision-action {
            font-weight: bold;
        }

        .decision-buy {
            color: #00b894;
        }

        .decision-sell {
            color: #ff6b6b;
        }

        .decision-hold {
            color: #fdcb6e;
        }

        .q-value {
            background: rgba(116, 185, 255, 0.3);
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        .analysis-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: #ccc;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #74b9ff;
            border-bottom: 2px solid #74b9ff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .learning-curve {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .curve-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #00b894;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            display: none;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .notification.error {
            background: #ff6b6b;
        }

        .notification.warning {
            background: #fdcb6e;
            color: #2d3436;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-running {
            background: #00b894;
            animation: pulse 2s infinite;
        }

        .status-paused {
            background: #fdcb6e;
        }

        .status-stopped {
            background: #ff6b6b;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .export-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px dashed rgba(255, 255, 255, 0.3);
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .rank-number {
            background: #74b9ff;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9em;
        }

        .debug-panel {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 0.8em;
            max-height: 150px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† Advanced Agents Control Panel</h1>
            <p>Monitor and control Q-Learning bots with real-time analysis</p>
            <div id="simulationStatus">
                <span class="status-indicator status-running"></span>
                <span id="statusText">Simulation Running</span>
            </div>
        </div>

        <div class="control-panel">
            <div class="control-card">
                <h3>üéÆ Simulation Control</h3>
                <button class="btn btn-warning" onclick="pauseSimulation()">‚è∏Ô∏è Pause & Analyze</button>
                <button class="btn btn-success" onclick="resumeSimulation()">‚ñ∂Ô∏è Resume</button>
                <button class="btn" onclick="stopSimulation()">‚èπÔ∏è Stop</button>
                <button class="btn btn-info" onclick="exportData()">üì• Export Data</button>
            </div>
            
            <div class="control-card">
                <h3>üìä Analysis Tools</h3>
                <button class="btn btn-info" onclick="generateComparison()">üîç Compare Bots</button>
                <button class="btn btn-info" onclick="getReputationReport()">üèÜ Reputation Report</button>
                <button class="btn btn-info" onclick="showLearningProgress()">üìà Learning Progress</button>
            </div>
            
            <div class="control-card">
                <h3>üéØ Bot Monitoring</h3>
                <select id="botSelector" onchange="selectBot()">
                    <option value="">Select a bot to monitor</option>
                </select>
                <button class="btn btn-info" onclick="watchBotThinking()">üëÅÔ∏è Watch Thinking</button>
                <button class="btn btn-info" onclick="analyzeBotDetails()">üî¨ Deep Analysis</button>
            </div>
        </div>

        <div class="bot-grid" id="botGrid">
            <!-- Bots will be populated here -->
        </div>

        <div class="analysis-panel">
            <div class="tabs">
                <button class="tab active" onclick="showTab('overview')">üìä Overview</button>
                <button class="tab" onclick="showTab('learning')">üß† Learning Analysis</button>
                <button class="tab" onclick="showTab('comparison')">‚öñÔ∏è Bot Comparison</button>
                <button class="tab" onclick="showTab('reputation')">üèÜ Reputation</button>
                <button class="tab" onclick="showTab('debug')">üîß Debug</button>
            </div>

            <div id="overview" class="tab-content active">
                <h3>Simulation Overview</h3>
                <div id="overviewContent">
                    <p>Loading simulation data...</p>
                </div>
            </div>

            <div id="learning" class="tab-content">
                <h3>Learning Progress Analysis</h3>
                <div id="learningContent">
                    <p>Select a bot to see learning analysis</p>
                </div>
            </div>

            <div id="comparison" class="tab-content">
                <h3>Bot Performance Comparison</h3>
                <div id="comparisonContent">
                    <p>Click "Compare Bots" to generate comparison</p>
                </div>
            </div>

            <div id="reputation" class="tab-content">
                <h3>Reputation System</h3>
                <div id="reputationContent">
                    <p>Click "Reputation Report" to see reputation analysis</p>
                </div>
            </div>

            <div id="debug" class="tab-content">
                <h3>Debug Information</h3>
                <div id="debugContent" class="debug-panel">
                    Debug info will appear here...
                </div>
            </div>
        </div>

        <div class="export-section">
            <h3>üì§ Data Export & Research</h3>
            <p>Export simulation data for research purposes or external analysis</p>
            <div style="margin-top: 10px;">
                <button class="btn btn-info" onclick="exportJSON()">üìÑ Export as JSON</button>
                <button class="btn btn-info" onclick="exportCSV()">üìä Export as CSV</button>
                <button class="btn btn-info" onclick="generateReport()">üìã Generate Report</button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        let socket;
        let selectedBotId = null;
        let watchingBot = false;
        let simulationData = {};
        let debugMode = false;

        // Debug logging function
        function debugLog(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const debugContent = document.getElementById('debugContent');
            
            if (debugContent) {
                const logEntry = document.createElement('div');
                logEntry.innerHTML = `[${timestamp}] ${message}${data ? ' - ' + JSON.stringify(data, null, 2) : ''}`;
                debugContent.appendChild(logEntry);
                debugContent.scrollTop = debugContent.scrollHeight;
                
                // Keep only last 50 entries
                while (debugContent.children.length > 50) {
                    debugContent.removeChild(debugContent.firstChild);
                }
            }
            
            console.log(`[${timestamp}] ${message}`, data || '');
        }

        // Initialize socket connection
        function initSocket() {
            debugLog('üîå Iniciando conexi√≥n al servidor...');
            
            try {
                socket = io();
                
                socket.on('connect', () => {
                    debugLog('‚úÖ Conectado al servidor');
                    showNotification('Conectado al servidor', 'success');
                    loadBotData();
                });

                socket.on('disconnect', () => {
                    debugLog('‚ùå Desconectado del servidor');
                    showNotification('Desconectado del servidor', 'error');
                });

                socket.on('connect_error', (error) => {
                    debugLog('‚ùå Error de conexi√≥n', error);
                    showNotification('Error de conexi√≥n al servidor', 'error');
                });

                // Simulation control events
                socket.on('simulation_paused', (data) => {
                    debugLog('‚è∏Ô∏è Simulaci√≥n pausada', data);
                    updateStatus('paused', 'Simulation Paused');
                    showNotification('Simulaci√≥n pausada para an√°lisis', 'warning');
                    if (data.analysis) {
                        displayAnalysis(data.analysis);
                    }
                });

                socket.on('simulation_resumed', (data) => {
                    debugLog('‚ñ∂Ô∏è Simulaci√≥n reanudada', data);
                    updateStatus('running', 'Simulation Running');
                    showNotification('Simulaci√≥n reanudada', 'success');
                });

                socket.on('simulation_stopped', (data) => {
                    debugLog('‚èπÔ∏è Simulaci√≥n detenida', data);
                    updateStatus('stopped', 'Simulation Stopped');
                    showNotification('Simulaci√≥n detenida', 'error');
                    if (data.finalAnalysis) {
                        displayAnalysis(data.finalAnalysis);
                    }
                });

                // Bot analysis events
                socket.on('bot_thinking_process', (data) => {
                    debugLog('üß† Proceso de pensamiento del bot recibido', data);
                    displayThinkingProcess(data);
                });

                socket.on('detailed_bot_analysis', (data) => {
                    debugLog('üî¨ An√°lisis detallado del bot recibido', data);
                    displayBotAnalysis(data);
                });

                socket.on('bot_decision_history', (data) => {
                    debugLog('üìã Historial de decisiones recibido', data);
                    displayDecisionHistory(data);
                });

                socket.on('reputation_report', (data) => {
                    debugLog('üèÜ Reporte de reputaci√≥n recibido', data);
                    displayReputationReport(data.report);
                });

                socket.on('simulation_export', (data) => {
                    debugLog('üì§ Datos de exportaci√≥n recibidos', data);
                    downloadData(data.data, data.filename);
                });

                // Watch events
                socket.on('bot_watching_started', (data) => {
                    debugLog('üëÅÔ∏è Observaci√≥n iniciada', data);
                    showNotification(`Observando ${data.botName}`, 'info');
                });

                socket.on('bot_watching_stopped', (data) => {
                    debugLog('üëÅÔ∏è Observaci√≥n detenida', data);
                    showNotification(`Dejando de observar ${data.botName}`, 'info');
                });

                // Error handling
                socket.on('error', (error) => {
                    debugLog('‚ùå Error del servidor', error);
                    showNotification(`Error: ${error.message}`, 'error');
                });

            } catch (error) {
                debugLog('‚ùå Error inicializando socket', error);
                showNotification('Error inicializando conexi√≥n', 'error');
            }
        }

        // Load bot data from server
        function loadBotData() {
            debugLog('üìä Cargando datos de simulaci√≥n...');
            
            fetch('/api/simulation-status')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    debugLog('üìä Datos de simulaci√≥n recibidos', data);
                    simulationData = data;
                    
                    const qBots = data.qLearningBots || [];
                    debugLog(`üß† Q-Learning bots encontrados: ${qBots.length}`);
                    
                    updateBotGrid(qBots);
                    updateBotSelector(qBots);
                    updateOverview(data);
                })
                .catch(error => {
                    debugLog('‚ùå Error cargando datos', error);
                    showNotification('Error cargando datos de simulaci√≥n', 'error');
                    
                    // Fallback data for testing
                    const fallbackData = {
                        qLearningBots: [
                            {
                                id: 'test-bot-1',
                                name: 'TestBot Alpha',
                                strategy: 'q_learning_aggressive',
                                netWorth: 1200,
                                qTableSize: 42,
                                epsilon: 0.3,
                                transactions: 15
                            }
                        ],
                        tickCount: 1,
                        totalBots: 1,
                        isRunning: true,
                        isPaused: false
                    };
                    
                    debugLog('üìä Usando datos de fallback');
                    updateBotGrid(fallbackData.qLearningBots);
                    updateBotSelector(fallbackData.qLearningBots);
                    updateOverview(fallbackData);
                });
        }

        // Update bot grid display
        function updateBotGrid(bots) {
            debugLog('ü§ñ Actualizando grid de bots', bots);
            const grid = document.getElementById('botGrid');
            
            if (!grid) {
                debugLog('‚ùå No se encontr√≥ el elemento botGrid');
                return;
            }
            
            grid.innerHTML = '';

            if (!bots || bots.length === 0) {
                grid.innerHTML = '<div class="bot-card"><p>No hay bots Q-Learning disponibles</p></div>';
                return;
            }

            bots.forEach(bot => {
                try {
                    const card = createBotCard(bot);
                    grid.appendChild(card);
                } catch (error) {
                    debugLog('‚ùå Error creando tarjeta de bot', { error, bot });
                }
            });
        }

        // Create bot card element
        function createBotCard(bot) {
            const card = document.createElement('div');
            card.className = 'bot-card';
            
            const botData = {
                id: bot.id || 'unknown',
                name: bot.name || 'Unknown Bot',
                strategy: bot.strategy || 'unknown',
                netWorth: bot.netWorth || 0,
                qTableSize: bot.qTableSize || 0,
                epsilon: bot.epsilon || 0,
                transactions: bot.transactions || 0
            };
            
            card.innerHTML = `
                <div class="bot-header">
                    <div class="bot-name">${botData.name}</div>
                    <div class="bot-strategy">${botData.strategy}</div>
                </div>
                
                <div class="bot-stats">
                    <div class="stat-item">
                        <div class="stat-value">${Math.round(botData.netWorth)}</div>
                        <div class="stat-label">Net Worth</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${botData.transactions}</div>
                        <div class="stat-label">Transactions</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${(botData.epsilon * 100).toFixed(1)}%</div>
                        <div class="stat-label">Exploration</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${botData.qTableSize}</div>
                        <div class="stat-label">Q-States</div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-info" onclick="selectBotById('${botData.id}')">üìä Analyze</button>
                    <button class="btn btn-warning" onclick="watchBotById('${botData.id}')">üëÅÔ∏è Watch</button>
                </div>
                
                <div id="thinking-${botData.id}" class="thinking-process">
                    <h4>üß† Thinking Process</h4>
                    <div id="thinking-steps-${botData.id}"></div>
                </div>
                
                <div id="decisions-${botData.id}" class="decision-history">
                    <h4>üìã Recent Decisions</h4>
                    <div id="decision-list-${botData.id}"></div>
                </div>
            `;
            
            return card;
        }

        // Update bot selector dropdown
        function updateBotSelector(bots) {
            const selector = document.getElementById('botSelector');
            if (!selector) {
                debugLog('‚ùå No se encontr√≥ el elemento botSelector');
                return;
            }
            
            selector.innerHTML = '<option value="">Select a bot to monitor</option>';
            
            if (!bots || bots.length === 0) {
                const option = document.createElement('option');
                option.disabled = true;
                option.textContent = 'No bots available';
                selector.appendChild(option);
                return;
            }
            
            bots.forEach(bot => {
                const option = document.createElement('option');
                option.value = bot.id || 'unknown';
                option.textContent = `${bot.name || 'Unknown'} (${bot.strategy || 'unknown'})`;
                selector.appendChild(option);
            });
        }

        // Control functions
        function pauseSimulation() {
            debugLog('‚è∏Ô∏è Pausando simulaci√≥n...');
            if (!socket || !socket.connected) {
                showNotification('No conectado al servidor', 'error');
                return;
            }
            
            socket.emit('pause_simulation');
            showNotification('Pausando simulaci√≥n...', 'warning');
        }

        function resumeSimulation() {
            debugLog('‚ñ∂Ô∏è Reanudando simulaci√≥n...');
            if (!socket || !socket.connected) {
                showNotification('No conectado al servidor', 'error');
                return;
            }
            
            socket.emit('resume_simulation');
            showNotification('Reanudando simulaci√≥n...', 'success');
        }

        function stopSimulation() {
            debugLog('‚èπÔ∏è Deteniendo simulaci√≥n...');
            if (!socket || !socket.connected) {
                showNotification('No conectado al servidor', 'error');
                return;
            }
            
            if (confirm('¬øEst√°s seguro de que quieres detener la simulaci√≥n?')) {
                socket.emit('stop_simulation');
                showNotification('Deteniendo simulaci√≥n...', 'error');
            }
        }

        function exportData() {
            debugLog('üì§ Exportando datos...');
            if (!socket || !socket.connected) {
                showNotification('No conectado al servidor', 'error');
                return;
            }
            
            socket.emit('export_simulation');
            showNotification('Exportando datos...', 'info');
        }

        // Bot analysis functions
        function selectBot() {
            const selector = document.getElementById('botSelector');
            if (!selector) return;
            
            selectedBotId = selector.value;
            debugLog('üéØ Bot seleccionado', { botId: selectedBotId });
            
            if (selectedBotId) {
                showNotification(`Bot seleccionado: ${selector.options[selector.selectedIndex].text}`, 'info');
            }
        }

        function selectBotById(botId) {
            debugLog('üéØ Seleccionando bot por ID', { botId });
            selectedBotId = botId;
            
            const selector = document.getElementById('botSelector');
            if (selector) {
                selector.value = botId;
            }
            
            analyzeBotDetails();
        }

        function watchBotThinking() {
            if (!selectedBotId) {
                showNotification('Por favor selecciona un bot primero', 'error');
                return;
            }
            
            if (!socket || !socket.connected) {
                showNotification('No conectado al servidor', 'error');
                return;
            }
            
            watchingBot = !watchingBot;
            debugLog(`üëÅÔ∏è ${watchingBot ? 'Iniciando' : 'Deteniendo'} observaci√≥n`, { botId: selectedBotId });
            
            socket.emit('watch_bot_thinking', { 
                botId: selectedBotId, 
                enable: watchingBot 
            });
            
            const message = watchingBot ? 'Iniciando observaci√≥n...' : 'Deteniendo observaci√≥n...';
            showNotification(message, 'info');
            
            const thinkingDiv = document.getElementById(`thinking-${selectedBotId}`);
            if (thinkingDiv) {
                thinkingDiv.style.display = watchingBot ? 'block' : 'none';
            }
        }

        function watchBotById(botId) {
            debugLog('üëÅÔ∏è Observando bot por ID', { botId });
            selectedBotId = botId;
            
            const selector = document.getElementById('botSelector');
            if (selector) {
                selector.value = botId;
            }
            
            watchingBot = false;
            watchBotThinking();
        }

        function analyzeBotDetails() {
            if (!selectedBotId) {
                showNotification('Por favor selecciona un bot primero', 'error');
                return;
            }
            
            if (!socket || !socket.connected) {
                showNotification('No conectado al servidor', 'error');
                return;
            }
            
            debugLog('üî¨ Analizando bot', { botId: selectedBotId });
            socket.emit('analyze_bot', { botId: selectedBotId });
            showNotification('Generando an√°lisis detallado...', 'info');
            
            // Tambi√©n solicitar historial de decisiones
            socket.emit('get_bot_decisions', { botId: selectedBotId, count: 20 });
        }

        // Display functions
        function displayThinkingProcess(data) {
            debugLog('üß† Mostrando proceso de pensamiento', data);
            
            const stepsContainer = document.getElementById(`thinking-steps-${data.botId}`);
            if (!stepsContainer) {
                debugLog('‚ö†Ô∏è No se encontr√≥ contenedor de pasos para bot', { botId: data.botId });
                return;
            }
            
            stepsContainer.innerHTML = '';
            
            if (!data.decisionProcess || data.decisionProcess.length === 0) {
                stepsContainer.innerHTML = '<p>No hay proceso de pensamiento disponible</p>';
                return;
            }
            
            data.decisionProcess.forEach(step => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'thinking-step';
                stepDiv.innerHTML = `
                    <div class="step-title">${(step.step || 'Unknown').replace(/_/g, ' ').toUpperCase()}</div>
                    <div class="step-explanation">${step.explanation || 'No explanation available'}</div>
                    ${step.result ? `<div style="font-size: 0.8em; color: #74b9ff; margin-top: 3px;">Result: ${JSON.stringify(step.result).substring(0, 100)}...</div>` : ''}
                `;
                stepsContainer.appendChild(stepDiv);
            });
            
            stepsContainer.scrollTop = stepsContainer.scrollHeight;
            
            const thinkingDiv = document.getElementById(`thinking-${data.botId}`);
            if (thinkingDiv) {
                thinkingDiv.style.display = 'block';
            }
        }

        function displayBotAnalysis(data) {
            debugLog('üìä Mostrando an√°lisis de bot', data);
            
            if (!data.analysis) {
                showNotification('No se recibieron datos de an√°lisis', 'error');
                return;
            }
            
            const analysis = data.analysis;
            
            const learningContent = document.getElementById('learningContent');
            if (learningContent) {
                learningContent.innerHTML = `
                    <h4>ü§ñ ${analysis.botInfo?.name || 'Unknown Bot'} - Learning Analysis</h4>
                    
                    <div class="learning-curve">
                        <h5>Performance Metrics</h5>
                        <div class="curve-item">
                            <span>Current Net Worth:</span>
                            <span class="stat-value">${analysis.performance?.currentNetWorth || 'N/A'}</span>
                        </div>
                        <div class="curve-item">
                            <span>Performance:</span>
                            <span class="stat-value">${analysis.performance?.performancePercent || 'N/A'}</span>
                        </div>
                        <div class="curve-item">
                            <span>Win Rate:</span>
                            <span class="stat-value">${analysis.performance?.winRate || 'N/A'}</span>
                        </div>
                        <div class="curve-item">
                            <span>Total Transactions:</span>
                            <span class="stat-value">${analysis.performance?.totalTransactions || 0}</span>
                        </div>
                    </div>
                    
                    <div class="learning-curve">
                        <h5>Learning Progress</h5>
                        <div class="curve-item">
                            <span>Q-Table Size:</span>
                            <span class="stat-value">${analysis.botInfo?.learningProgress?.qTableSize || 0} states</span>
                        </div>
                        <div class="curve-item">
                            <span>Current Exploration Rate:</span>
                            <span class="stat-value">${analysis.botInfo?.learningProgress?.explorationRate || '0'}%</span>
                        </div>
                        <div class="curve-item">
                            <span>Learning Episodes:</span>
                            <span class="stat-value">${analysis.botInfo?.learningProgress?.episodes || 0}</span>
                        </div>
                        <div class="curve-item">
                            <span>Success Rate:</span>
                            <span class="stat-value">${analysis.botInfo?.learningProgress?.successRate || '0%'}</span>
                        </div>
                    </div>
                    
                    ${analysis.qTableSample ? `
                    <div class="learning-curve">
                        <h5>Q-Table Sample (Top Learned Actions)</h5>
                        ${(analysis.qTableSample.topEntries || []).map(entry => `
                            <div class="curve-item">
                                <span>${entry.action?.type} ${entry.action?.resource} (${entry.action?.quantity})</span>
                                <span class="q-value">Q: ${entry.qValue || 'N/A'}</span>
                            </div>
                        `).join('')}
                        <div style="margin-top: 10px; font-size: 0.9em; color: #ccc;">
                            Total learned states: ${analysis.qTableSample.totalEntries || 0}
                        </div>
                    </div>
                    ` : ''}
                `;
            }
            
            showTab('learning');
            showNotification('An√°lisis completado', 'success');
        }

        function displayDecisionHistory(data) {
            debugLog('üìã Mostrando historial de decisiones', data);
            
            const decisionsContainer = document.getElementById(`decision-list-${data.botId}`);
            if (!decisionsContainer) {
                debugLog('‚ö†Ô∏è No se encontr√≥ contenedor de decisiones para bot', { botId: data.botId });
                return;
            }
            
            decisionsContainer.innerHTML = '';
            
            if (!data.decisions || data.decisions.length === 0) {
                decisionsContainer.innerHTML = '<p>No hay decisiones disponibles</p>';
                return;
            }
            
            data.decisions.slice(0, 10).forEach(decision => {
                const decisionDiv = document.createElement('div');
                decisionDiv.className = 'decision-item';
                
                const action = decision.action || {};
                const confidence = decision.confidence || 0;
                
                decisionDiv.innerHTML = `
                    <div>
                        <span class="decision-action decision-${action.type || 'hold'}">${action.type || 'hold'}</span>
                        ${action.resource ? ` ${action.quantity || 0} ${action.resource}` : ''}
                    </div>
                    <div>
                        <span class="q-value">Conf: ${(confidence * 100).toFixed(1)}%</span>
                    </div>
                `;
                decisionsContainer.appendChild(decisionDiv);
            });
            
            const decisionsDiv = document.getElementById(`decisions-${data.botId}`);
            if (decisionsDiv) {
                decisionsDiv.style.display = 'block';
            }
        }

        function displayReputationReport(report) {
            debugLog('üèÜ Mostrando reporte de reputaci√≥n', report);
            
            const reputationContent = document.getElementById('reputationContent');
            if (reputationContent) {
                reputationContent.innerHTML = `
                    <div class="learning-curve">
                        <h5>Reputation Overview</h5>
                        <div class="curve-item">
                            <span>Total Bots:</span>
                            <span class="stat-value">${report.totalBots || 0}</span>
                        </div>
                        <div class="curve-item">
                            <span>Average Reputation:</span>
                            <span class="stat-value">${(report.averageReputation || 0).toFixed(1)}</span>
                        </div>
                        <div class="curve-item">
                            <span>Suspicious Activities:</span>
                            <span class="stat-value">${report.suspiciousActivities || 0}</span>
                        </div>
                    </div>
                    
                    <div class="learning-curve">
                        <h5>Trust Distribution</h5>
                        ${Object.entries(report.trustDistribution || {}).map(([level, count]) => `
                            <div class="curve-item">
                                <span>${level.replace('_', ' ').toUpperCase()}:</span>
                                <span class="stat-value">${count}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="learning-curve">
                        <h5>Behavior Profiles</h5>
                        ${Object.entries(report.behaviorProfiles || {}).map(([profile, count]) => `
                            <div class="curve-item">
                                <span>${profile.replace('_', ' ').toUpperCase()}:</span>
                                <span class="stat-value">${count}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            showTab('reputation');
            showNotification('Reporte de reputaci√≥n actualizado', 'success');
        }

        function showTab(tabName) {
            debugLog('üìë Mostrando pesta√±a', { tabName });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const tabContent = document.getElementById(tabName);
            if (tabContent) {
                tabContent.classList.add('active');
            }
            
            const activeTab = document.querySelector(`[onclick="showTab('${tabName}')"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
        }

        function updateOverview(data) {
            const overviewContent = document.getElementById('overviewContent');
            if (!overviewContent) return;
            
            overviewContent.innerHTML = `
                <div class="comparison-grid">
                    <div class="learning-curve">
                        <h4>üéÆ Simulation Status</h4>
                        <div class="curve-item">
                            <span>Total Ticks:</span>
                            <span class="stat-value">${data.tickCount || 0}</span>
                        </div>
                        <div class="curve-item">
                            <span>Active Bots:</span>
                            <span class="stat-value">${data.participants?.qLearningBots || 0}</span>
                        </div>
                        <div class="curve-item">
                            <span>Status:</span>
                            <span class="stat-value">${data.isPaused ? 'Paused' : data.isRunning ? 'Running' : 'Stopped'}</span>
                        </div>
                    </div>
                    
                    <div class="learning-curve">
                        <h4>üìà Bot Overview</h4>
                        <div class="curve-item">
                            <span>Q-Learning Bots:</span>
                            <span class="stat-value">${(data.qLearningBots || []).length}</span>
                        </div>
                        <div class="curve-item">
                            <span>Analysis Mode:</span>
                            <span class="stat-value">${data.isAnalysisMode ? 'Active' : 'Inactive'}</span>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 15px;">
                    <h4>ü§ñ Q-Learning Bot Summary</h4>
                    <div class="comparison-grid">
                        ${(data.qLearningBots || []).map(bot => `
                            <div class="curve-item">
                                <span>${bot.name || 'Unknown'}:</span>
                                <span class="stat-value">${Math.round(bot.netWorth || 0)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function showNotification(message, type = 'info') {
            debugLog(`üì¢ Notificaci√≥n [${type}]`, { message });
            
            const notification = document.getElementById('notification');
            if (notification) {
                notification.textContent = message;
                notification.className = `notification ${type}`;
                notification.style.display = 'block';
                
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
        }

        function updateStatus(status, text) {
            const indicator = document.querySelector('.status-indicator');
            const statusText = document.getElementById('statusText');
            
            if (indicator) {
                indicator.className = `status-indicator status-${status}`;
            }
            
            if (statusText) {
                statusText.textContent = text;
            }
        }

        // Additional analysis functions
        function generateComparison() {
            debugLog('üîç Generando comparaci√≥n de bots...');
            
            if (!socket || !socket.connected) {
                showNotification('No conectado al servidor', 'error');
                return;
            }
            
            // Request bot comparison data
            socket.emit('generate_bot_comparison');
            showNotification('Generando comparaci√≥n de bots...', 'info');
            
            // For now, show a placeholder
            const comparisonContent = document.getElementById('comparisonContent');
            if (comparisonContent) {
                comparisonContent.innerHTML = `
                    <div class="learning-curve">
                        <h5>Bot Performance Ranking</h5>
                        ${(simulationData.qLearningBots || []).map((bot, index) => `
                            <div class="ranking-item">
                                <div class="rank-number">${index + 1}</div>
                                <span>${bot.name}</span>
                                <span class="stat-value">${Math.round(bot.netWorth || 0)}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            showTab('comparison');
        }

        function getReputationReport() {
            debugLog('üèÜ Solicitando reporte de reputaci√≥n...');
            
            if (!socket || !socket.connected) {
                showNotification('No conectado al servidor', 'error');
                return;
            }
            
            socket.emit('get_reputation_report');
            showNotification('Generando reporte de reputaci√≥n...', 'info');
        }

        function showLearningProgress() {
            debugLog('üìà Mostrando progreso de aprendizaje...');
            
            if (!selectedBotId) {
                showNotification('Por favor selecciona un bot primero', 'error');
                return;
            }
            
            showTab('learning');
            analyzeBotDetails();
        }

        // Utility functions
        function downloadData(data, filename) {
            try {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification(`Descargado ${filename}`, 'success');
            } catch (error) {
                debugLog('‚ùå Error descargando archivo', error);
                showNotification('Error al descargar archivo', 'error');
            }
        }

        function displayAnalysis(analysis) {
            debugLog('üìä Mostrando an√°lisis general', analysis);
            showNotification('An√°lisis completado', 'success');
            
            // Display analysis in overview tab
            const overviewContent = document.getElementById('overviewContent');
            if (overviewContent && analysis) {
                const analysisHtml = `
                    <div style="margin-top: 20px;">
                        <h4>üîç Analysis Results</h4>
                        <div class="learning-curve">
                            <div class="curve-item">
                                <span>Analysis Type:</span>
                                <span class="stat-value">${analysis.type || 'Unknown'}</span>
                            </div>
                            <div class="curve-item">
                                <span>Timestamp:</span>
                                <span class="stat-value">${new Date(analysis.timestamp || Date.now()).toLocaleTimeString()}</span>
                            </div>
                            ${analysis.summary ? `
                                <div class="curve-item">
                                    <span>Total Bots:</span>
                                    <span class="stat-value">${analysis.summary.totalBots || 0}</span>
                                </div>
                                <div class="curve-item">
                                    <span>Average Performance:</span>
                                    <span class="stat-value">${(analysis.summary.averagePerformance || 0).toFixed(2)}%</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                overviewContent.innerHTML += analysisHtml;
            }
        }

        // Export functions
        function exportJSON() { 
            exportData(); 
        }
        
        function exportCSV() { 
            showNotification('Exportaci√≥n CSV en desarrollo', 'warning'); 
        }
        
        function generateReport() { 
            showNotification('Generaci√≥n de reportes en desarrollo', 'warning'); 
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('üöÄ Iniciando panel de control avanzado...');
            
            initSocket();
            
            // Auto-refresh every 30 seconds
            setInterval(() => {
                if (socket && socket.connected) {
                    loadBotData();
                }
            }, 30000);
            
            debugLog('‚úÖ Panel de control inicializado');
        });

        // Handle page errors
        window.addEventListener('error', function(e) {
            debugLog('‚ùå Error de JavaScript', {
                message: e.message,
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno
            });
        });

        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function(e) {
            debugLog('‚ùå Promesa rechazada', {
                reason: e.reason
            });
        });
    </script>
</body>
</html>